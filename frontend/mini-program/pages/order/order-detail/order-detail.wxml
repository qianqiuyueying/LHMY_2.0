<!--pages/order/order-detail/order-detail.wxml-->
<view class="container" wx:if="{{!loading && order}}">
  <view class="card">
    <view class="info-row">
      <text class="label">订单号</text>
      <text class="value">{{order.id}}</text>
    </view>
    <view class="info-row">
      <text class="label">订单类型</text>
      <text class="value">{{order.orderType === 'PRODUCT' ? '商品订单' : '服务包订单'}}</text>
    </view>
    <view class="info-row">
      <text class="label">订单状态</text>
      <text class="value">{{paymentStatusText}}</text>
    </view>
    <view class="info-row">
      <text class="label">订单金额</text>
      <text class="value amount">¥{{order.totalAmount}}</text>
    </view>
    <view class="info-row">
      <text class="label">下单时间</text>
      <text class="value">{{order.createdAt}}</text>
    </view>
    <view class="info-row" wx:if="{{order.paidAt}}">
      <text class="label">支付时间</text>
      <text class="value">{{order.paidAt}}</text>
    </view>
  </view>

  <!-- 物流信息（仅物流商品） -->
  <view class="card" wx:if="{{order.fulfillmentType === 'PHYSICAL_GOODS'}}">
    <view class="section-title">物流信息</view>
    <view class="info-row">
      <text class="label">物流状态</text>
      <text class="value">{{fulfillmentStatusText || '-'}}</text>
    </view>
    <view class="info-row">
      <text class="label">快递公司</text>
      <text class="value">{{order.shippingCarrier || '-'}}</text>
    </view>
    <view class="info-row">
      <text class="label">运单号</text>
      <text class="value">{{order.shippingTrackingNo || '-'}}</text>
    </view>
    <view class="info-row" wx:if="{{order.shippedAt}}">
      <text class="label">发货时间</text>
      <text class="value">{{order.shippedAt}}</text>
    </view>
    <view class="info-row" wx:if="{{order.deliveredAt}}">
      <text class="label">妥投时间</text>
      <text class="value">{{order.deliveredAt}}</text>
    </view>
    <view class="info-row" wx:if="{{order.receivedAt}}">
      <text class="label">签收时间</text>
      <text class="value">{{order.receivedAt}}</text>
    </view>
  </view>

  <view class="card" wx:if="{{order.fulfillmentType === 'PHYSICAL_GOODS' && order.shippingAddress}}">
    <view class="section-title">收货地址</view>
    <view class="addr-row">
      <text class="addr-name">{{order.shippingAddress.receiverName}}</text>
      <text class="addr-phone">{{order.shippingAddress.receiverPhone}}</text>
    </view>
    <view class="addr-line">{{order.shippingAddress.addressLine}}</view>
  </view>

  <!-- 订单明细 -->
  <view class="card">
    <view class="section-title">订单明细</view>
    <view 
      class="order-item"
      wx:for="{{order.items || []}}"
      wx:key="id"
    >
      <view class="item-main">
        <text class="item-name">{{item.title}}</text>
        <button
          class="btn btn-ghost btn-mini"
          wx:if="{{order.paymentStatus === 'PAID' && order.fulfillmentType === 'SERVICE' && item.itemType === 'PRODUCT'}}"
          data-item-id="{{item.id}}"
          bindtap="onBookService"
        >去预约</button>
      </view>
      <view class="item-info">
        <text class="item-quantity">x{{item.quantity}}</text>
        <text class="item-price">¥{{item.unitPrice}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 底部操作栏 -->
<view class="bottom-cta-bar" wx:if="{{order && order.paymentStatus === 'PENDING'}}">
  <button class="btn btn-primary" bindtap="onPay" disabled="{{paying}}">
    {{paying ? '处理中…' : '立即支付'}}
  </button>
</view>

<view class="bottom-cta-bar" wx:elif="{{order && order.fulfillmentType === 'PHYSICAL_GOODS' && order.paymentStatus === 'PAID' && (order.fulfillmentStatus === 'SHIPPED' || order.fulfillmentStatus === 'DELIVERED')}}">
  <button class="btn btn-primary" bindtap="onConfirmReceived" disabled="{{confirming}}">
    {{confirming ? '处理中…' : '确认收货'}}
  </button>
</view>
