<!--pages/ai-chat/ai-chat.wxml-->
<view class="container">
  <!-- 对话区 -->
  <scroll-view class="messages" scroll-y="true" scroll-into-view="{{'msg-' + (messages.length - 1)}}" scroll-with-animation="true">
    <!-- 免责声明（置于对话顶部：不遮挡操作） -->
    <view class="disclaimer card" wx:if="{{showDisclaimer}}">
      <view class="disclaimer-content">
        <text class="disclaimer-title">免责声明</text>
        <text class="disclaimer-text">AI 仅供参考，不承担责任</text>
      </view>
      <button class="btn btn-ghost disclaimer-close" bindtap="onCloseDisclaimer">我知道了</button>
    </view>

    <!-- 空态引导 -->
    <view class="state-wrap" wx:if="{{aiDisabled}}">
      <view class="state-card">
        <view class="state-graphic"></view>
        <view class="state-title">AI 暂未开放</view>
        <view class="state-desc">{{aiDisabledMessage || 'AI 功能已停用'}}</view>
        <view class="state-actions">
          <button class="btn btn-primary" bindtap="onGoSupport">客服与帮助</button>
          <button class="btn btn-ghost" bindtap="onCloseDisclaimer">关闭提示</button>
        </view>
      </view>
    </view>

    <view class="state-wrap" wx:elif="{{messages.length === 0 && !loading}}">
      <view class="state-card">
        <view class="state-graphic"></view>
        <view class="state-title">AI 对话</view>
        <view class="state-desc">请输入你的问题，我会尽力回答。</view>
      </view>
    </view>

    <view 
      class="message-item {{item.role === 'user' ? 'user' : 'ai'}}"
      wx:for="{{messages}}"
      wx:key="index"
      id="msg-{{index}}"
    >
      <view class="message-content">
        <text>{{item.content}}</text>
      </view>
    </view>
    <view class="message-item ai" wx:if="{{loading}}">
      <view class="message-content is-loading">
        <text>AI 正在思考…</text>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区 -->
  <view class="input-bar">
    <input 
      class="input" 
      placeholder="输入您的问题..." 
      value="{{inputValue}}"
      bindinput="onInput"
      bindconfirm="onSend"
      disabled="{{loading || aiDisabled}}"
    />
    <button class="btn btn-primary send-btn" bindtap="onSend" disabled="{{loading || aiDisabled || !canSend}}">发送</button>
  </view>
</view>
