## 完成事实清单：H5（frontend/h5）

> 口径：本文件只写“事实”（已经存在的行为/代码结构），每条都给出**证据入口**（文件路径/接口路径/关键函数）。

### A) 入口与路由

- [x] **Vite + Vue3 + Vant4** 工程存在  
  - 证据：`frontend/h5/package.json`（依赖）、`frontend/h5/src/main.ts`
- [x] 路由结构固定为 4 个路径：`/h5`、`/h5/buy`、`/h5/pay/result`、兜底 404  
  - 证据：`frontend/h5/src/main.ts`

### B) API 客户端与通用约定

- [x] API 前缀硬编码为 `/api/v1`，并通过相对路径访问（由 nginx/同源反代决定最终 host）  
  - 证据：`frontend/h5/src/lib/api.ts` 常量 `API_PREFIX`
- [x] token 存储在 `localStorage`，key 为 `lhmy_h5_token`  
  - 证据：`frontend/h5/src/lib/api.ts` 常量 `TOKEN_KEY`
- [x] 写操作支持 `Idempotency-Key`（H5 侧生成 UUID v4）  
  - 证据：`frontend/h5/src/lib/api.ts` 函数 `newIdempotencyKey()`
- [x] 统一错误码到中文提示映射（示例：UNAUTHENTICATED/STATE_CONFLICT/ORDER_TYPE_NOT_ALLOWED 等）  
  - 证据：`frontend/h5/src/lib/api.ts` 函数 `presentErrorMessage()`

### C) 经销商投放参数（dealer link）

- [x] **vNext：H5 投放入口主参数为 `dealerLinkId`（可长期投放）**  
  - 证据：`frontend/h5/src/lib/dealer.ts` `parseDealerLinkId()` / `pickDealerQuery()`
- [x] H5 使用只读解析接口获取“经销商 + 可售卡（可选）”  
  - 接口：`GET /api/v1/h5/dealer-links/{dealerLinkId}`  
  - 证据：`frontend/h5/src/pages/LandingPage.vue`、`frontend/h5/src/pages/BuyPage.vue`；后端：`backend/app/api/v1/h5_config.py`
- [x] 若为“经销商首页链接”（未指定卡），H5 拉取该经销商“已生成投放链接且可用”的卡列表  
  - 接口：`GET /api/v1/h5/dealer-links/{dealerLinkId}/cards`  
  - 事实：列表项 sellableCard 附带 `services[serviceType,totalCount]`，H5 可在列表直接展示“服务类别×次数”摘要  
  - 证据：`frontend/h5/src/pages/LandingPage.vue`；后端：`backend/app/api/v1/h5_config.py`

### D) 页面与接口依赖（按页面）

#### D1) 落地页 `LandingPage.vue`（`/h5`）

- [x] 通过 `dealerLinkId` 解析经销商入口身份：`GET /api/v1/h5/dealer-links/{dealerLinkId}`  
  - 事实：带 `sellableCardId` 时会**直达购卡页** `/h5/buy?dealerLinkId=...&sellableCardId=...`  
  - 证据：`frontend/h5/src/pages/LandingPage.vue` `loadDealerContext()`
- [x] 门禁（最高）：无 `dealerLinkId` 时，“立即购买”入口不可点击（置灰/不可见）并提示“请通过经销商投放链接购买”  
  - 证据：`frontend/h5/src/pages/LandingPage.vue`
- [x] 经销商首页：展示“该经销商可售卡”（来自 dealer-links/{id}/cards）  
  - 证据：`frontend/h5/src/pages/LandingPage.vue`
- [x] 服务包模板详情加载：`GET /api/v1/service-packages/{templateId}`  
  - 证据：`frontend/h5/src/pages/LandingPage.vue` `loadServicePackage()`
- [x] FAQ/条款加载：`GET /api/v1/h5/landing/faq-terms`  
  - 证据：`frontend/h5/src/pages/LandingPage.vue` `loadFaqTerms()`

#### D2) 购买页 `BuyPage.vue`（`/h5/buy`）

- [x] 通过 `dealerLinkId` 解析经销商入口身份：`GET /api/v1/h5/dealer-links/{dealerLinkId}`  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `loadDealerContext()`
- [x] 通过 `dealerLinkId + sellableCardId` 获取卡详情并校验授权：`GET /api/v1/h5/dealer-links/{dealerLinkId}/cards/{sellableCardId}`  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `loadDealerContext()`；后端：`backend/app/api/v1/h5_config.py`
- [x] 区域配置读取：`GET /api/v1/regions/cities`（用于 `REGION_CITIES`）  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `loadRegions()`
- [x] 购买区域选择体验：省/市支持“级联选择 + 搜索”；省卡必须选到省、市卡必须选到市  
  - 证据：`frontend/h5/src/pages/BuyPage.vue`（region popup）
- [x] 购卡页展示该卡服务内容（服务大类 × 次数）：`GET /api/v1/service-packages/{templateId}`  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `loadServicePackage()`
- [x] 服务协议读取：`GET /api/v1/h5/legal/service-agreement`  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `openAgreement()`
- [x] 匿名购卡（不登录）：购卡页填写“订单联系手机号”（不用于登录），下单时提交到后端作为快照字段  
  - 字段：`buyerPhone`（后端落库字段 `orders.buyer_phone`；对外展示仅脱敏）  
  - 证据：`frontend/h5/src/pages/BuyPage.vue`（手机号输入 + submit）、后端：`backend/app/api/v1/orders.py` `CreateOrderBody.buyerPhone`
- [x] 创建订单：`POST /api/v1/orders`（Header: `Idempotency-Key`；Query: `dealerLinkId` 必填；Body: `buyerPhone` 必填）  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `submit()`、后端：`backend/app/api/v1/orders.py` `create_order()`
- [x] 发起支付：`POST /api/v1/orders/{id}/pay`（Header: `Idempotency-Key`；body: `{paymentMethod:"WECHAT"}`）  
  - 证据：`frontend/h5/src/pages/BuyPage.vue` `submit()`

#### D3) 支付结果页 `PayResultPage.vue`（`/h5/pay/result`）

- [x] 小程序入口信息读取（用于提示用户去小程序查看权益）：`GET /api/v1/h5/mini-program/launch`  
  - 证据：`frontend/h5/src/pages/PayResultPage.vue` `loadLaunch()`
- [x] 事实：当前未引入微信 JS-SDK；以“可执行的兜底提示”引导用户手动打开小程序  
  - 证据：`frontend/h5/src/pages/PayResultPage.vue` `openMiniProgram()`

### E) 与后端的关键契约（H5 视角）

- [x] H5 创建 `SERVICE_PACKAGE` 订单必须携带 `dealerLinkId`，并据此绑定订单 `dealerId`  
  - 证据：`backend/app/api/v1/orders.py` `create_order()`（`dealerLinkId`）
- [x] H5 允许创建 `SERVICE_PACKAGE` 类型订单（小程序不允许）  
  - 证据：同上（`backend/app/api/v1/orders.py`）

### F) 最小可执行使用路径（给测试/运营/回归）

> 目标：只按现有实现，给出一条从“投放链接”到“支付结果页”的最短路径（不引入额外能力假设）。

- [x] **步骤 1：从 Dealer 投放链接进入 H5**
  - URL 形态：`/h5?dealerLinkId=...`
  - 说明：
    - 若仅有 `dealerLinkId`：展示该经销商可售卡列表，点选进入购卡页
    - 若同时带 `sellableCardId`：直达购卡页 `/h5/buy?dealerLinkId=...&sellableCardId=...`
  - 证据：`frontend/h5/src/pages/LandingPage.vue`

- [x] **步骤 2：购买页填写信息并提交**
  - 必填：订单联系手机号（不用于登录）+ 勾选服务协议
  - 若 `regionLevel=PROVINCE/CITY`：需选择购买区域；`COUNTRY` 时展示“全国（默认）”
  - 证据：`frontend/h5/src/pages/BuyPage.vue`

- [x] **步骤 3：后端下单/发起支付**
  - 下单：`POST /api/v1/orders`（Header: `Idempotency-Key`；Query: `dealerLinkId`；Body: `buyerPhone`）
  - 支付：`POST /api/v1/orders/{id}/pay`（Header: `Idempotency-Key`）
  - 证据：`frontend/h5/src/pages/BuyPage.vue`

- [x] **步骤 4：跳转支付结果页**
  - 成功/失败都进入：`/h5/pay/result?status=...&reason=...`（并保留 `dealerLinkId` 便于“重试支付”）
  - 成功时提供“打开小程序查看权益”的兜底提示（不依赖微信 JS-SDK）
  - 证据：`frontend/h5/src/pages/PayResultPage.vue`


